<!DOCTYPE html>
<!-- saved from url=(0076)https://watchmysys.com/blog/2015/10/build-package-your-software-for-openwrt/ -->
<html lang="en-US"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width">
<title>Build and package your own software for OpenWRT | ¬´WatchMySys¬ª Blog</title>
<link rel="profile" href="http://gmpg.org/xfn/11">
<link rel="pingback" href="https://watchmysys.com/blog/xmlrpc.php">
<!--[if lt IE 9]>
<script src="https://watchmysys.com/blog/wp-content/themes/twentytwelve/js/html5.js" type="text/javascript"></script>
<![endif]-->
<link rel="dns-prefetch" href="https://fonts.googleapis.com/">
<link rel="dns-prefetch" href="https://s.w.org/">
<link href="https://fonts.gstatic.com/" crossorigin="" rel="preconnect">
<link rel="alternate" type="application/rss+xml" title="¬´WatchMySys¬ª Blog ¬ª Feed" href="https://watchmysys.com/blog/feed/">
<link rel="alternate" type="application/rss+xml" title="¬´WatchMySys¬ª Blog ¬ª Comments Feed" href="https://watchmysys.com/blog/comments/feed/">
<link rel="alternate" type="application/rss+xml" title="¬´WatchMySys¬ª Blog ¬ª Build and package your own software for OpenWRT Comments Feed" href="https://watchmysys.com/blog/2015/10/build-package-your-software-for-openwrt/feed/">
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.2.1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.2.1\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/watchmysys.com\/blog\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.7.2"}};
			!function(a,b,c){function d(a){var b,c,d,e,f=String.fromCharCode;if(!k||!k.fillText)return!1;switch(k.clearRect(0,0,j.width,j.height),k.textBaseline="top",k.font="600 32px Arial",a){case"flag":return k.fillText(f(55356,56826,55356,56819),0,0),!(j.toDataURL().length<3e3)&&(k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,57331,65039,8205,55356,57096),0,0),b=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,57331,55356,57096),0,0),c=j.toDataURL(),b!==c);case"emoji4":return k.fillText(f(55357,56425,55356,57341,8205,55357,56507),0,0),d=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55357,56425,55356,57341,55357,56507),0,0),e=j.toDataURL(),d!==e}return!1}function e(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i,j=b.createElement("canvas"),k=j.getContext&&j.getContext("2d");for(i=Array("flag","emoji4"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script><script src="./Build and package your own software for OpenWRT _ ¬´WatchMySys¬ª Blog_files/wp-emoji-release.min.js.t·∫£i xu·ªëng" type="text/javascript" defer=""></script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel="stylesheet" id="collapseomatic-css-css" href="./Build and package your own software for OpenWRT _ ¬´WatchMySys¬ª Blog_files/light_style.css" type="text/css" media="all">
<link rel="stylesheet" id="twentytwelve-fonts-css" href="./Build and package your own software for OpenWRT _ ¬´WatchMySys¬ª Blog_files/css" type="text/css" media="all">
<link rel="stylesheet" id="twentytwelve-style-css" href="./Build and package your own software for OpenWRT _ ¬´WatchMySys¬ª Blog_files/style.css" type="text/css" media="all">
<!--[if lt IE 9]>
<link rel='stylesheet' id='twentytwelve-ie-css'  href='https://watchmysys.com/blog/wp-content/themes/twentytwelve/css/ie.css?ver=20121010' type='text/css' media='all' />
<![endif]-->
<script type="text/javascript" src="./Build and package your own software for OpenWRT _ ¬´WatchMySys¬ª Blog_files/jquery.js.t·∫£i xu·ªëng"></script>
<script type="text/javascript" src="./Build and package your own software for OpenWRT _ ¬´WatchMySys¬ª Blog_files/jquery-migrate.min.js.t·∫£i xu·ªëng"></script>
<link rel="https://api.w.org/" href="https://watchmysys.com/blog/wp-json/">
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://watchmysys.com/blog/xmlrpc.php?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://watchmysys.com/blog/wp-includes/wlwmanifest.xml"> 
<link rel="prev" title="Building Linux 4.1 for the Banana Pi" href="https://watchmysys.com/blog/2015/07/building-linux-4-1-for-the-banana-pi/">
<link rel="next" title="Arch Linux and SDIO WiFi on a Bay Trail tablet" href="https://watchmysys.com/blog/2015/12/arch-linux-and-sdio-wifi-on-a-bay-trail-tablet/">
<meta name="generator" content="WordPress 4.7.2">
<link rel="canonical" href="https://watchmysys.com/blog/2015/10/build-package-your-software-for-openwrt/">
<link rel="shortlink" href="https://watchmysys.com/blog/?p=461">
<link rel="alternate" type="application/json+oembed" href="https://watchmysys.com/blog/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fwatchmysys.com%2Fblog%2F2015%2F10%2Fbuild-package-your-software-for-openwrt%2F">
<link rel="alternate" type="text/xml+oembed" href="https://watchmysys.com/blog/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fwatchmysys.com%2Fblog%2F2015%2F10%2Fbuild-package-your-software-for-openwrt%2F&amp;format=xml">
		<style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style>
		</head>

<body class="post-template-default single single-post postid-461 single-format-standard custom-font-enabled single-author">
<div id="page" class="hfeed site">
	<header id="masthead" class="site-header" role="banner">
		<hgroup>
			<h1 class="site-title"><a href="https://watchmysys.com/blog/" title="¬´WatchMySys¬ª Blog" rel="home">¬´WatchMySys¬ª Blog</a></h1>
			<h2 class="site-description">Guaranteed to be pseudorandom</h2>
		</hgroup>

		<nav id="site-navigation" class="main-navigation" role="navigation">
			<button class="menu-toggle">Menu</button>
			<a class="assistive-text" href="https://watchmysys.com/blog/2015/10/build-package-your-software-for-openwrt/#content" title="Skip to content">Skip to content</a>
			<div class="nav-menu"><ul>
<li><a href="https://watchmysys.com/blog/">Home</a></li></ul></div>
		</nav><!-- #site-navigation -->

			</header><!-- #masthead -->

	<div id="main" class="wrapper">
	<div id="primary" class="site-content">
		<div id="content" role="main">

			
				
	<article id="post-461" class="post-461 post type-post status-publish format-standard hentry category-embedded category-linux">
				<header class="entry-header">
			
						<h1 class="entry-title">Build and package your own software for OpenWRT</h1>
										<div class="comments-link">
					<a href="https://watchmysys.com/blog/2015/10/build-package-your-software-for-openwrt/#comments">5 Replies</a>				</div><!-- .comments-link -->
					</header><!-- .entry-header -->

				<div class="entry-content">
			<p>Today I am going to discuss how to build and package your own software for OpenWRT.</p>
<p>When I say ‚Äúyour own software‚Äù in this case I am referring to a C program which you want to cross-compile for the target SoC and install using the opkg package manager included in OpenWRT.</p>
<p>The program I wrote is a little more complicated than your standard ‚ÄúHello World‚Äù application. Here‚Äôs what I wanted to do:<br>
1) use libconfig to read a configuration file in /etc/config/ and then perform actions based on the configuration described in this file<br>
2) use sqlite3 to create a database<br>
3) write some meaningful data to the database</p>
<p>Here‚Äôs the program flow:<br>
1) Open /etc/config/example-sqlite and read the values into variables<br>
2) Open (or create) a new SQLite3 database file at the location defined in the above configuration file<br>
3) Determine if the SQLite file is initialized with the target table we want to write to, and if not, create the table<br>
4) Write the system load average to the database<br>
5) Quit</p>
<p>To recap, this program is different from ‚ÄúHello World‚Äù in the following ways:<br>
1) It must read and understand a configuration file in libconfig syntax; this requires linking against the libconfig library, which we must tell opkg is a dependency<br>
2) It must create or open an SQLite 3 database; this requires linking against the sqlite3 library, which we must tell opkg is a depenedency<br>
3) It must perform some useful operations on this SQLite file</p>
<p>Let‚Äôs start with compiling the C file on your native architecture. Sure, you can just use cc/gcc from bash, but this isn‚Äôt any good to OpenWRT SDK, which expects that each package will have a makefile which can be used to compile the software.</p>
<p><code>load2sqlite.c</code></p>
<pre>#include &lt;sys/types.h&gt;
#include &lt;string.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;sqlite3.h&gt;
#include &lt;libconfig.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;errno.h&gt;

int main(int argc, char *argv[]) {
// ...
</pre>
<p>Most importantly above, we are including <code>sqlite3.h</code> for SQLite support, <code>libconfig.h</code>, and <code>sys/stat.h</code>, <code>fcntl.h</code>,<code>errno.h</code> to check if the SQLite3 database file exists or not.</p>
<p>You can compile this by hand quite easily, just by doing:<br>
<code>cc load2sqlite.c -lsqlite3 -lconfig -o load2sqlite</code></p>
<p>Okay, but how do we make this ready for OpenWRT SDK? By writing a makefile!</p>
<p><code>makefile</code></p>
<pre>PROFILE = -O2 -s
CFLAGS = $(PROFILE)
LDFLAGS = -lsqlite3 -lconfig

all: main

# build it
main:
	$(CC) $(CFLAGS) load2sqlite.c $(LDFLAGS) -o load2sqlite

# clean it
clean:
	rm load2sqlite
</pre>
<p>Okay, so now if you type <code>make</code> in the directory, magically you will end up with an executable called load2sqlite!</p>
<p>But, this is a native binary, and it‚Äôs somewhat unlikely that your OpenWRT device is on the same architecture.</p>
<pre>load2sqlite: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=9661b88e92b553d0556cbeeafccf04d2526c770f, stripped
</pre>
<p>If you run it, you‚Äôll see that it looks for the sqlite database file, can‚Äôt find it, and so initalizes a new one with the ‚Äúreadings‚Äù table.</p>
<pre>[hmartin@localhost src]$ ./load2sqlite 
Database file /tmp/sqlite3.db does not exist
Initialized database with readings table
[hmartin@localhost src]$ echo "select * from readings;" | sqlite3 /tmp/sqlite3.db 
2015-10-28 22:48:42|0.57|0.56|0.57
</pre>
<p>And if you run it again, without removing the SQLite3 file that was created, you‚Äôll see this output:</p>
<pre>[hmartin@localhost src]$ ./load2sqlite
SQLite database opened
Found readings table
[hmartin@localhost src]$ echo "select * from readings;" | sqlite3 /tmp/sqlite3.db 
2015-10-28 22:48:42|0.57|0.56|0.57
2015-10-28 22:49:00|0.47|0.54|0.57
</pre>
<p>Before we proceed further, I want to show you the directory structure so you have an idea of where we just were when we did this compilation. We are currently in the the <code>src</code> directory.</p>
<pre>load2sqlite/
|-- Makefile
|-- README
`-- src
    |-- load2sqlite.c
    |-- load2sqlite.conf
    `-- makefile
</pre>
<p>Now let‚Äôs move up to the <code>load2sqlite</code> directory and work on the OpenWRT Makefile (seen above).</p>
<p>Here is the complete file, and then we will discuss it section by section:<br>
<code>Makefile</code></p>
<pre>#
# Copyright (C) 2006-2015 OpenWrt.org
#
# This is free software, licensed under the GNU General Public License v2.
# See /LICENSE for more information.
#

include $(TOPDIR)/rules.mk

PKG_NAME:=load2sqlite
PKG_VERSION:=1.0.1
PKG_RELEASE:=5
PKG_MAINTAINER:=Hal Martin 
PKG_LICENSE:=GPL-2
PKG_CONFIG_DEPENDS:=libsqlite3 libconfig

include $(INCLUDE_DIR)/package.mk

PKG_BUILD_DIR := $(BUILD_DIR)/$(PKG_NAME)-$(PKG_VERSION)

TARGET_LDFLAGS+= \
  -Wl,-rpath-link=$(STAGING_DIR)/usr/lib \
  -Wl,-rpath-link=$(STAGING_DIR)/usr/lib/libconfig/lib \
  -Wl,-rpath-link=$(STAGING_DIR)/usr/lib/sqlite/lib

define Package/load2sqlite
  SECTION:=utils
  CATEGORY:=Utilities
  DEPENDS:=+libsqlite3 +libconfig
  TITLE:=SQLite example program, creates or opens a user defined SQLite database
  URL:=https://github.com/halmartin/load2sqlite
  MENU:=1
endef

define Package/load2sqlite/description
 Example SQLite is a sample program built using libsqlite3 and libconfig
 which creates or opens a user-defined SQLite3 database and performs some
 simple verification checks on the file to ensure that the target table (readings)
 exists, and if not creates the table, then inserts a row with the current system
 time, and the load (1 minute, 5 minute, 15 minute).
endef

define Build/Prepare
	mkdir -p $(PKG_BUILD_DIR)
	$(CP) ./src/* $(PKG_BUILD_DIR)/
endef

define Build/Configure
endef

define Build/Compile
	$(MAKE) -C $(PKG_BUILD_DIR) $(TARGET_CONFIGURE_OPTS)
endef

define Package/load2sqlite/install
	$(INSTALL_DIR) $(1)/bin
	$(INSTALL_BIN) $(PKG_BUILD_DIR)/load2sqlite $(1)/bin/
	$(INSTALL_DIR) $(1)/etc/config
	$(INSTALL_CONF) $(PKG_BUILD_DIR)/load2sqlite.conf $(1)/etc/config/load2sqlite
endef

$(eval $(call BuildPackage,load2sqlite))
</pre>
<p>If you clone the OpenWRT source and take a look at basically any package, you‚Äôll see a Makefile that looks similar to the one above.</p>
<p>Let‚Äôs look at the package information:</p>
<pre>PKG_NAME:=load2sqlite
PKG_VERSION:=1.0.1
PKG_RELEASE:=5
PKG_MAINTAINER:=Hal Martin 
PKG_LICENSE:=GPL-2
</pre>
<p>Here is where we define core details of our package, such as the name (e.g. what opkg will know it as), the version (useful for upgrading later), maintainer, and license.</p>
<pre>TARGET_LDFLAGS+= \
  -Wl,-rpath-link=$(STAGING_DIR)/usr/lib \
  -Wl,-rpath-link=$(STAGING_DIR)/usr/lib/libconfig/lib \
  -Wl,-rpath-link=$(STAGING_DIR)/usr/lib/sqlite/lib
</pre>
<p>Since we want to build a program which links against external libraries, we must also tell the compiler where to find the header files for these libraries, so that the linking process does not fail during compilation. Above you can see that we are linking to libconfig and sqlite libraries.</p>
<pre>define Package/load2sqlite
  SECTION:=utils
  CATEGORY:=Utilities
  DEPENDS:=+libsqlite3 +libconfig
  TITLE:=SQLite example program, creates or opens a user defined SQLite database
  URL:=https://github.com/halmartin/load2sqlite
  MENU:=1
endef
</pre>
<p>This is where you define the package for the OpenWRT build system and declare things like dependencies, and the description that will be present when you run <code>menuconfig</code> (which is how you will select your package to be built as part of an image).</p>
<p>Without declaring dependencies, you may find that you can build, package, and install your software, but it won‚Äôt run! So, by declaring the dependencies (packages which provide the libraries we link against) we ensure that when we type <code>opkg install load2sqlite</code> and libconfig and libsqlite3 are not installed, opkg knows to go and install them before installing our program. Now we can safely run the program because all the required libraries are installed on the device! </p>
<pre>define Build/Prepare
	mkdir -p $(PKG_BUILD_DIR)
	$(CP) ./src/* $(PKG_BUILD_DIR)/
endef

define Build/Configure
endef
</pre>
<p>Since our utility is quite simple, as *NIX software goes, the preparation steps are to create the build directory and copy the source from the source directory to the build directory. Since there is nothing to configure in our sample program, the configure step is empty (otherwise the OpenWRT build system will attempt to configure the package and fail because we haven‚Äôt bothered to implement this).</p>
<pre>define Build/Compile
	$(MAKE) -C $(PKG_BUILD_DIR) $(TARGET_CONFIGURE_OPTS)
endef

define Package/load2sqlite/install
	$(INSTALL_DIR) $(1)/bin
	$(INSTALL_BIN) $(PKG_BUILD_DIR)/load2sqlite $(1)/bin/
	$(INSTALL_DIR) $(1)/etc/config
	$(INSTALL_CONF) $(PKG_BUILD_DIR)/load2sqlite.conf $(1)/etc/config/load2sqlite
endef
</pre>
<p>Finally, compile and install the software. As you can see above, I didn‚Äôt include an install directive in the makefile of the application, it is instead done manually within the OpenWRT Makefile. This is your choice, since I was designing this program specifically to run on OpenWRT, I saw no need to incorporate the installation steps in the makefile of the program.</p>
<p>And, finally:</p>
<pre>$(eval $(call BuildPackage,load2sqlite))
</pre>
<p>This line is required for OpenWRT to build the package. Forget this line, and you will sit there wondering why your package is not being built!</p>
<hr>
<p>Okay, now we have prepared our software to be built for OpenWRT. It would be stupid of me to get this far and not tell you how to compile it using the OpenWRT toolchain!</p>
<p>Following the excellent OpenWRT documentation, we need to set up a <a href="http://wiki.openwrt.org/doc/howto/buildroot.exigence">buildroot</a>.</p>
<p>Install the dependencies (instructions for Debian/Ubuntu):</p>
<pre>sudo apt-get install git-core build-essential libssl-dev libncurses5-dev unzip subversion mercurial
</pre>
<p>Clone the OpenWRT <a href="http://wiki.openwrt.org/doc/howto/buildroot.exigence#downloading_sources">Chaos Calmer release</a>:</p>
<pre>git clone git://git.openwrt.org/15.05/openwrt.git
</pre>
<p>I find that the stock OpenWRT repository is a bit light on some of the software I like to have on my routers, so I take step 3 and install the additional feeds:</p>
<pre>cd openwrt
./scripts/feeds update -a
./scripts/feeds install -a
</pre>
<p>Follow step 4 to ensure you have all the required dependencies installed on your host system!</p>
<pre>make defconfig
make prereq
# don't forget to copy load2sqlite to package/utils/ before running this step, or the package won't appear in the menu!
make menuconfig
</pre>
<p>If everything has gone well thus far (e.g. no errors in the OpenWRT Makefile, and you put <code>load2sqlite</code> in <code>package/utils/</code> then you should see the following in your menuconfig:</p>
<p><a href="./Build and package your own software for OpenWRT _ ¬´WatchMySys¬ª Blog_files/menuconfig_load2sqlite.png"><img src="./Build and package your own software for OpenWRT _ ¬´WatchMySys¬ª Blog_files/menuconfig_load2sqlite.png" alt="menuconfig_load2sqlite" width="762" height="454" class="alignnone size-full wp-image-497"></a></p>
<p><a href="./Build and package your own software for OpenWRT _ ¬´WatchMySys¬ª Blog_files/menuconfig_load2sqlite_desc.png"><img src="./Build and package your own software for OpenWRT _ ¬´WatchMySys¬ª Blog_files/menuconfig_load2sqlite_desc.png" alt="menuconfig_load2sqlite_desc" width="762" height="454" class="alignnone size-full wp-image-498"></a></p>
<p>Now I already have an official OpenWRT build installed on my router, so I don‚Äôt need to build an entire image, just the package I want to install. To do this, we must first build the cross compilation toolchain required to compile for a different CPU architecture.</p>
<p><strong>Warning:</strong> the OpenWRT buildroot is around 6GB on disk, so ensure you have the necessary space before starting!</p>
<pre>make tools/install
# this will take a while the first time
make toolchain/install
# this will also take a while the first time
</pre>
<p>When we have the tools and toolchain compiled, we can compile our package:</p>
<pre>make package/load2sqlite/compile
</pre>
<p>This will create an ipkg file in <code>bin/ramips/packages/base/load2sqlite_1.0.1-5_ramips_24kec.ipk</code> which we need to copy to our router to install:</p>
<pre>scp bin/ramips/packages/base/load2sqlite_1.0.1-5_ramips_24kec.ipk root@192.168.1.1:/tmp/
# scp completes
ssh root@192.168.1.1
root@192.168.1.1's password:

BusyBox v1.23.2 (2015-07-25 03:03:02 CEST) built-in shell (ash)

  _______                     ________        __
 |       |.-----.-----.-----.|  |  |  |.----.|  |_
 |   -   ||  _  |  -__|     ||  |  |  ||   _||   _|
 |_______||   __|_____|__|__||________||__|  |____|
          |__| W I R E L E S S   F R E E D O M
 -----------------------------------------------------
 CHAOS CALMER (15.05, r46767)
 -----------------------------------------------------
  * 1 1/2 oz Gin            Shake with a glassful
  * 1/4 oz Triple Sec       of broken ice and pour
  * 3/4 oz Lime Juice       unstrained into a goblet.
  * 1 1/2 oz Orange Juice
  * 1 tsp. Grenadine Syrup
 -----------------------------------------------------
root@OpenWrt:~# opkg install /tmp/load2sqlite_1.0.1-5_ramips_24kec.ipk 
Installing load2sqlite (1.0.1-4) to root...
Installing libsqlite3 (3081101-1) to root...
Downloading http://downloads.openwrt.org/chaos_calmer/15.05/ramips/mt7620/packages/packages/libsqlite3_3081101-1_ramips_24kec.ipk.
Installing libpthread (0.9.33.2-1) to root...
Downloading http://downloads.openwrt.org/chaos_calmer/15.05/ramips/mt7620/packages/base/libpthread_0.9.33.2-1_ramips_24kec.ipk.
Installing libconfig (1.4.9-1) to root...
Downloading http://downloads.openwrt.org/chaos_calmer/15.05/ramips/mt7620/packages/base/libconfig_1.4.9-1_ramips_24kec.ipk.
Configuring libpthread.
Configuring libconfig.
Configuring libsqlite3.
Configuring load2sqlite.
</pre>
<p>Now that our package is installed, we can test it!</p>
<pre>root@OpenWrt:~# /bin/load2sqlite 
Database file /tmp/sqlite3.db does not exist
Initialized database with readings table
</pre>
<p>If you install sqlite3-cli we can inspect the row added to the file:</p>
<pre>root@OpenWrt:~# opkg install sqlite3-cli
root@OpenWrt:~# echo "select * from readings;" | sqlite3 /tmp/sqlite3.db 
2015-10-31 20:47:33|0.76|0.4|0.25
</pre>
<p>Since this is just an example program, it is one-shot (e.g. not a daemon). If you really do want to track the load of our OpenWRT router, just add /bin/load2sqlite to crontab (e.g. every hour) and you‚Äôll have this tracking info in the SQLite database.</p>
<p>If you run it multiple times, you get another row added to the file each time the program is run:</p>
<pre>root@OpenWrt:~# /bin/load2sqlite 
SQLite database opened
Found readings table
root@OpenWrt:~# echo "select * from readings;" | sqlite3 /tmp/sqlite3.db 
2015-10-31 20:47:33|0.76|0.4|0.25
2015-10-31 20:53:43|0.02|0.2|0.22
2015-10-31 21:23:19|0.08|0.04|0.05
</pre>
<p>Note that by default the file is saved to /tmp/, which on OpenWRT is a <strong>ramdisk</strong>. This means that the file will be lost when you reboot, or if you leave it running unattended for too long, the file size will grow to the point where the ramdisk will consume all available memory and the router will crash. For this reason, I suggest you modify the configuration file <code>/etc/config/load2sqlite</code> to point to non-volatile storage (such as a USB stick).</p>
<hr>
<p><strong>Source code:</strong> <a href="https://github.com/halmartin/load2sqlite">https://github.com/halmartin/load2sqlite</a></p>
<hr>
<p><strong>Why write another OpenWRT software guide?</strong></p>
<p>Well, while I was looking for resources on how to build and package software for OpenWRT, I ran into a lot of posts about people compiling simple ‚ÄúHello World‚Äù programs for OpenWRT, but for my particular use case, I wanted to utilize multiple libraries in my program, and I couldn‚Äôt find any good instructions on how to compile a program with linked libraries for OpenWRT.</p>
<p>Disclaimer: I‚Äôm not a C expert, so maybe there are some headers there which are not strictly necessary, but it works for me and the executable size is quite small.</p>
<p>If you wish to further reduce the size of your executable, you can tell the compiler to strip it of the symbol table and relocation information. Do this by appending <code>-s</code> to the PROFILE line in the makefile. When I did this on my laptop, the output went from 9.9KB to 7.0KB, or a savings of 30%</p>
<p>I have tested this on Chaos Calmer (15.05), and I expect the instructions would also work on Barrier Breaker (14.07) however I didn‚Äôt try this, so I cannot say certainly that it will work.</p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
			This entry was posted in <a href="https://watchmysys.com/blog/category/embedded/" rel="category tag">Embedded</a>, <a href="https://watchmysys.com/blog/category/linux/" rel="category tag">Linux</a> on <a href="https://watchmysys.com/blog/2015/10/build-package-your-software-for-openwrt/" title="23:00" rel="bookmark"><time class="entry-date" datetime="2015-10-31T23:00:21+00:00">2015/10/31</time></a><span class="by-author"> by <span class="author vcard"><a class="url fn n" href="https://watchmysys.com/blog/author/halmartin/" title="View all posts by Hal Martin" rel="author">Hal Martin</a></span></span>.								</footer><!-- .entry-meta -->
	</article><!-- #post -->

				<nav class="nav-single">
					<h3 class="assistive-text">Post navigation</h3>
					<span class="nav-previous"><a href="https://watchmysys.com/blog/2015/07/building-linux-4-1-for-the-banana-pi/" rel="prev"><span class="meta-nav">‚Üê</span> Building Linux 4.1 for the Banana Pi</a></span>
					<span class="nav-next"><a href="https://watchmysys.com/blog/2015/12/arch-linux-and-sdio-wifi-on-a-bay-trail-tablet/" rel="next">Arch Linux and SDIO WiFi on a Bay Trail tablet <span class="meta-nav">‚Üí</span></a></span>
				</nav><!-- .nav-single -->

				
<div id="comments" class="comments-area">

	
			<h2 class="comments-title">
			5 thoughts on ‚Äú<span>Build and package your own software for OpenWRT</span>‚Äù		</h2>

		<ol class="commentlist">
				<li class="comment even thread-even depth-1" id="li-comment-13024">
		<article id="comment-13024" class="comment">
			<header class="comment-meta comment-author vcard">
				<img alt="" src="./Build and package your own software for OpenWRT _ ¬´WatchMySys¬ª Blog_files/a3154fc519bb7e515418d417f5399b24" srcset="https://secure.gravatar.com/avatar/a3154fc519bb7e515418d417f5399b24?s=88&amp;d=mm&amp;r=g 2x" class="avatar avatar-44 photo" height="44" width="44"><cite><b class="fn">TAMMY &amp; KEITH MCKENZIE</b> </cite><a href="https://watchmysys.com/blog/2015/10/build-package-your-software-for-openwrt/#comment-13024"><time datetime="2016-01-08T11:37:46+00:00">2016/01/08 at 11:37</time></a>			</header><!-- .comment-meta -->

			
			<section class="comment-content comment">
				<p>Hey this is great but i want to do more than build a package. i want to take source Foss factory code for routers cross compile and add support for routers that OPENWRT does not support yet.I know thats total development thats wait OPENWRT DEVELOPERS do but i want to get into doing  development too.I got source code i just don‚Äôt know how to compile it.I biuld my own  firmware with BB 14.07 i just don‚Äôt know how to add support to the configuration utility so i can cross compile it.People go to collage to learn this stuff but i don‚Äôt have time for that, im learning C but i got a long way to go you know a lot more than me. Information on building fimware is hard to fined,I like to know where  you got your information from on how you learned how to do this.This is the video i made and put it on youtube if i ever learn how to make new support for openwrt i will make a video on that.   </p>
<p><a href="https://www.youtube.com/watch?v=3YCVa6WA62k" rel="nofollow">https://www.youtube.com/watch?v=3YCVa6WA62k</a></p>
							</section><!-- .comment-content -->

			<div class="reply">
				<a rel="nofollow" class="comment-reply-link" href="https://watchmysys.com/blog/2015/10/build-package-your-software-for-openwrt/?replytocom=13024#respond" onclick="return addComment.moveForm( &quot;comment-13024&quot;, &quot;13024&quot;, &quot;respond&quot;, &quot;461&quot; )" aria-label="Reply to TAMMY &amp; KEITH MCKENZIE">Reply</a> <span>‚Üì</span>			</div><!-- .reply -->
		</article><!-- #comment-## -->
	<ol class="children">
	<li class="comment byuser comment-author-halmartin bypostauthor odd alt depth-2" id="li-comment-13869">
		<article id="comment-13869" class="comment">
			<header class="comment-meta comment-author vcard">
				<img alt="" src="./Build and package your own software for OpenWRT _ ¬´WatchMySys¬ª Blog_files/c289b096dd3f0d1ac57aec40f4d240c9" srcset="https://secure.gravatar.com/avatar/c289b096dd3f0d1ac57aec40f4d240c9?s=88&amp;d=mm&amp;r=g 2x" class="avatar avatar-44 photo" height="44" width="44"><cite><b class="fn"><a href="http://watchmysys.com/blog/" rel="external nofollow" class="url">Hal Martin</a></b> <span>Post author</span></cite><a href="https://watchmysys.com/blog/2015/10/build-package-your-software-for-openwrt/#comment-13869"><time datetime="2016-03-14T20:01:56+00:00">2016/03/14 at 20:01</time></a>			</header><!-- .comment-meta -->

			
			<section class="comment-content comment">
				<p>Hi,<br>
You might be interested in my post about building the software from D-Link‚Äôs source code:<br>
<a href="http://watchmysys.com/blog/2016/03/d-link-dap-1520-hacking-part-2/" rel="nofollow">http://watchmysys.com/blog/2016/03/d-link-dap-1520-hacking-part-2/</a></p>
<p>It is possible, although somewhat challenging, to build the router firmware from the vendor source code. However, this won‚Äôt get you any of the features of OpenWrt, it will just get you the same think that D-Link supplies, plus whatever you decide to add.</p>
<p>I‚Äôm still hoping to get OpenWrt running on this device, so you‚Äôll have to stay tuned to see if I‚Äôm successful or not!</p>
							</section><!-- .comment-content -->

			<div class="reply">
				<a rel="nofollow" class="comment-reply-link" href="https://watchmysys.com/blog/2015/10/build-package-your-software-for-openwrt/?replytocom=13869#respond" onclick="return addComment.moveForm( &quot;comment-13869&quot;, &quot;13869&quot;, &quot;respond&quot;, &quot;461&quot; )" aria-label="Reply to Hal Martin">Reply</a> <span>‚Üì</span>			</div><!-- .reply -->
		</article><!-- #comment-## -->
	</li><!-- #comment-## -->
</ol><!-- .children -->
</li><!-- #comment-## -->
	<li class="comment even thread-odd thread-alt depth-1" id="li-comment-14508">
		<article id="comment-14508" class="comment">
			<header class="comment-meta comment-author vcard">
				<img alt="" src="./Build and package your own software for OpenWRT _ ¬´WatchMySys¬ª Blog_files/9e5defd3cb13d40f58def66b2e35f5ac" srcset="https://secure.gravatar.com/avatar/9e5defd3cb13d40f58def66b2e35f5ac?s=88&amp;d=mm&amp;r=g 2x" class="avatar avatar-44 photo" height="44" width="44"><cite><b class="fn">Michael Behrns-Miller</b> </cite><a href="https://watchmysys.com/blog/2015/10/build-package-your-software-for-openwrt/#comment-14508"><time datetime="2016-05-25T18:29:30+00:00">2016/05/25 at 18:29</time></a>			</header><!-- .comment-meta -->

			
			<section class="comment-content comment">
				<p>Thanks this was just what I needed for my small C app that used other libraries.  Really clear and concise, surely saved me hours of time.</p>
							</section><!-- .comment-content -->

			<div class="reply">
				<a rel="nofollow" class="comment-reply-link" href="https://watchmysys.com/blog/2015/10/build-package-your-software-for-openwrt/?replytocom=14508#respond" onclick="return addComment.moveForm( &quot;comment-14508&quot;, &quot;14508&quot;, &quot;respond&quot;, &quot;461&quot; )" aria-label="Reply to Michael Behrns-Miller">Reply</a> <span>‚Üì</span>			</div><!-- .reply -->
		</article><!-- #comment-## -->
	</li><!-- #comment-## -->
	<li class="comment odd alt thread-even depth-1" id="li-comment-14708">
		<article id="comment-14708" class="comment">
			<header class="comment-meta comment-author vcard">
				<img alt="" src="./Build and package your own software for OpenWRT _ ¬´WatchMySys¬ª Blog_files/82f4e29d8b62e996f9f07e6db6a57b04" srcset="https://secure.gravatar.com/avatar/82f4e29d8b62e996f9f07e6db6a57b04?s=88&amp;d=mm&amp;r=g 2x" class="avatar avatar-44 photo" height="44" width="44"><cite><b class="fn"><a href="http://wavesys.pt/" rel="external nofollow" class="url">Mike</a></b> </cite><a href="https://watchmysys.com/blog/2015/10/build-package-your-software-for-openwrt/#comment-14708"><time datetime="2016-06-17T10:45:56+00:00">2016/06/17 at 10:45</time></a>			</header><!-- .comment-meta -->

			
			<section class="comment-content comment">
				<p>Hello,</p>
<p>This is a good source information about creating and packaging software into OpenWRT.<br>
The only problem that i see is that you inserted e non UCI config compliance into ‚Äú/etc/config‚Äù.<br>
It still works but its not the correct way. I would change libconfig with libuci to make it complaint or just save your load2sqlite config outside /etc/config</p>
							</section><!-- .comment-content -->

			<div class="reply">
				<a rel="nofollow" class="comment-reply-link" href="https://watchmysys.com/blog/2015/10/build-package-your-software-for-openwrt/?replytocom=14708#respond" onclick="return addComment.moveForm( &quot;comment-14708&quot;, &quot;14708&quot;, &quot;respond&quot;, &quot;461&quot; )" aria-label="Reply to Mike">Reply</a> <span>‚Üì</span>			</div><!-- .reply -->
		</article><!-- #comment-## -->
	<ol class="children">
	<li class="comment byuser comment-author-halmartin bypostauthor even depth-2" id="li-comment-15010">
		<article id="comment-15010" class="comment">
			<header class="comment-meta comment-author vcard">
				<img alt="" src="./Build and package your own software for OpenWRT _ ¬´WatchMySys¬ª Blog_files/c289b096dd3f0d1ac57aec40f4d240c9" srcset="https://secure.gravatar.com/avatar/c289b096dd3f0d1ac57aec40f4d240c9?s=88&amp;d=mm&amp;r=g 2x" class="avatar avatar-44 photo" height="44" width="44"><cite><b class="fn"><a href="http://watchmysys.com/blog/" rel="external nofollow" class="url">Hal Martin</a></b> <span>Post author</span></cite><a href="https://watchmysys.com/blog/2015/10/build-package-your-software-for-openwrt/#comment-15010"><time datetime="2016-07-13T20:08:58+00:00">2016/07/13 at 20:08</time></a>			</header><!-- .comment-meta -->

			
			<section class="comment-content comment">
				<p>Thanks for the tip! I‚Äôm working on other projects at the moment, but if I have time I‚Äôll look at updating this to use libuci as you suggest. Pull requests to the repo are also always welcome <img draggable="false" class="emoji" alt="üôÇ" src="./Build and package your own software for OpenWRT _ ¬´WatchMySys¬ª Blog_files/1f642.svg"></p>
							</section><!-- .comment-content -->

			<div class="reply">
				<a rel="nofollow" class="comment-reply-link" href="https://watchmysys.com/blog/2015/10/build-package-your-software-for-openwrt/?replytocom=15010#respond" onclick="return addComment.moveForm( &quot;comment-15010&quot;, &quot;15010&quot;, &quot;respond&quot;, &quot;461&quot; )" aria-label="Reply to Hal Martin">Reply</a> <span>‚Üì</span>			</div><!-- .reply -->
		</article><!-- #comment-## -->
	</li><!-- #comment-## -->
</ol><!-- .children -->
</li><!-- #comment-## -->
		</ol><!-- .commentlist -->

		
		
	
		<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title">Leave a Reply <small><a rel="nofollow" id="cancel-comment-reply-link" href="https://watchmysys.com/blog/2015/10/build-package-your-software-for-openwrt/#respond" style="display:none;">Cancel reply</a></small></h3>			<form action="https://watchmysys.com/blog/wp-comments-post.php" method="post" id="commentform" class="comment-form">
				<p class="comment-notes"><span id="email-notes">Your email address will not be published.</span> Required fields are marked <span class="required">*</span></p><p class="comment-form-comment"><label for="comment">Comment</label> <textarea id="comment" name="comment" cols="45" rows="8" maxlength="65525" aria-required="true" required="required"></textarea></p><p class="comment-form-author"><label for="author">Name <span class="required">*</span></label> <input id="author" name="author" type="text" value="" size="30" maxlength="245" aria-required="true" required="required"></p>
<p class="comment-form-email"><label for="email">Email <span class="required">*</span></label> <input id="email" name="email" type="text" value="" size="30" maxlength="100" aria-describedby="email-notes" aria-required="true" required="required"></p>
<p class="comment-form-url"><label for="url">Website</label> <input id="url" name="url" type="text" value="" size="30" maxlength="200"></p>
<p class="form-submit"><input name="submit" type="submit" id="submit" class="submit" value="Post Comment"> <input type="hidden" name="comment_post_ID" value="461" id="comment_post_ID">
<input type="hidden" name="comment_parent" id="comment_parent" value="0">
</p><p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="9efe6da509"></p><p style="display: none;"></p>			<input type="hidden" id="ak_js" name="ak_js" value="1487042883896"></form>
			</div><!-- #respond -->
	
</div><!-- #comments .comments-area -->
			
		</div><!-- #content -->
	</div><!-- #primary -->


			<div id="secondary" class="widget-area" role="complementary">
			<aside id="search-2" class="widget widget_search"><form role="search" method="get" id="searchform" class="searchform" action="https://watchmysys.com/blog/">
				<div>
					<label class="screen-reader-text" for="s">Search for:</label>
					<input type="text" value="" name="s" id="s">
					<input type="submit" id="searchsubmit" value="Search">
				</div>
			</form></aside>		<aside id="recent-posts-2" class="widget widget_recent_entries">		<h3 class="widget-title">Recent Posts</h3>		<ul>
					<li>
				<a href="https://watchmysys.com/blog/2017/02/flashing-firmware-intel-me/">Reassembling a firmware from pieces</a>
						</li>
					<li>
				<a href="https://watchmysys.com/blog/2017/01/intel-me-bios-password/">The wrong way to clear a BIOS password</a>
						</li>
					<li>
				<a href="https://watchmysys.com/blog/2016/12/allwinner-h3-h2-linux-49-ethernet/">Allwinner H2+/H3 Ethernet with Linux 4.9-rc8</a>
						</li>
					<li>
				<a href="https://watchmysys.com/blog/2016/12/intel-iot-dk200-hardware/">Intel DK200 IoT Gateway</a>
						</li>
					<li>
				<a href="https://watchmysys.com/blog/2016/04/the-real-meaning-of-109-gigabyte-gibibyte/">The real meaning of 10^9</a>
						</li>
				</ul>
		</aside>		<aside id="recent-comments-2" class="widget widget_recent_comments"><h3 class="widget-title">Recent Comments</h3><ul id="recentcomments"><li class="recentcomments"><span class="comment-author-link">rioreno</span> on <a href="https://watchmysys.com/blog/2017/01/intel-me-bios-password/#comment-17809">The wrong way to clear a BIOS password</a></li><li class="recentcomments"><span class="comment-author-link"><a href="http://watchmysys.com/blog/" rel="external nofollow" class="url">Hal Martin</a></span> on <a href="https://watchmysys.com/blog/2017/01/intel-me-bios-password/#comment-17707">The wrong way to clear a BIOS password</a></li><li class="recentcomments"><span class="comment-author-link">rioreno</span> on <a href="https://watchmysys.com/blog/2017/01/intel-me-bios-password/#comment-17659">The wrong way to clear a BIOS password</a></li><li class="recentcomments"><span class="comment-author-link"><a href="http://watchmysys.com/blog/" rel="external nofollow" class="url">Hal Martin</a></span> on <a href="https://watchmysys.com/blog/2015/12/arch-linux-and-sdio-wifi-on-a-bay-trail-tablet/#comment-17455">Arch Linux and SDIO WiFi on a Bay Trail tablet</a></li><li class="recentcomments"><span class="comment-author-link"><a href="http://watchmysys.com/blog/" rel="external nofollow" class="url">Hal Martin</a></span> on <a href="https://watchmysys.com/blog/2016/12/allwinner-h3-h2-linux-49-ethernet/#comment-17454">Allwinner H2+/H3 Ethernet with Linux 4.9-rc8</a></li></ul></aside><aside id="archives-2" class="widget widget_archive"><h3 class="widget-title">Archives</h3>		<ul>
			<li><a href="https://watchmysys.com/blog/2017/02/">February 2017</a></li>
	<li><a href="https://watchmysys.com/blog/2017/01/">January 2017</a></li>
	<li><a href="https://watchmysys.com/blog/2016/12/">December 2016</a></li>
	<li><a href="https://watchmysys.com/blog/2016/04/">April 2016</a></li>
	<li><a href="https://watchmysys.com/blog/2016/03/">March 2016</a></li>
	<li><a href="https://watchmysys.com/blog/2015/12/">December 2015</a></li>
	<li><a href="https://watchmysys.com/blog/2015/10/">October 2015</a></li>
	<li><a href="https://watchmysys.com/blog/2015/07/">July 2015</a></li>
	<li><a href="https://watchmysys.com/blog/2015/05/">May 2015</a></li>
	<li><a href="https://watchmysys.com/blog/2015/02/">February 2015</a></li>
	<li><a href="https://watchmysys.com/blog/2015/01/">January 2015</a></li>
	<li><a href="https://watchmysys.com/blog/2014/11/">November 2014</a></li>
	<li><a href="https://watchmysys.com/blog/2014/10/">October 2014</a></li>
	<li><a href="https://watchmysys.com/blog/2014/09/">September 2014</a></li>
	<li><a href="https://watchmysys.com/blog/2014/08/">August 2014</a></li>
	<li><a href="https://watchmysys.com/blog/2014/07/">July 2014</a></li>
	<li><a href="https://watchmysys.com/blog/2014/06/">June 2014</a></li>
	<li><a href="https://watchmysys.com/blog/2014/05/">May 2014</a></li>
	<li><a href="https://watchmysys.com/blog/2014/03/">March 2014</a></li>
	<li><a href="https://watchmysys.com/blog/2014/02/">February 2014</a></li>
	<li><a href="https://watchmysys.com/blog/2013/08/">August 2013</a></li>
		</ul>
		</aside><aside id="categories-2" class="widget widget_categories"><h3 class="widget-title">Categories</h3>		<ul>
	<li class="cat-item cat-item-31"><a href="https://watchmysys.com/blog/category/embedded/">Embedded</a>
</li>
	<li class="cat-item cat-item-3"><a href="https://watchmysys.com/blog/category/linux/">Linux</a>
</li>
	<li class="cat-item cat-item-2"><a href="https://watchmysys.com/blog/category/networking/">Networking</a>
</li>
	<li class="cat-item cat-item-13"><a href="https://watchmysys.com/blog/category/security/">Security</a>
</li>
	<li class="cat-item cat-item-1"><a href="https://watchmysys.com/blog/category/uncategorized/">Uncategorized</a>
</li>
		</ul>
</aside><aside id="meta-2" class="widget widget_meta"><h3 class="widget-title">Meta</h3>			<ul>
						<li><a href="https://watchmysys.com/blog/wp-login.php">Log in</a></li>
			<li><a href="https://watchmysys.com/blog/feed/">Entries <abbr title="Really Simple Syndication">RSS</abbr></a></li>
			<li><a href="https://watchmysys.com/blog/comments/feed/">Comments <abbr title="Really Simple Syndication">RSS</abbr></a></li>
			<li><a href="https://wordpress.org/" title="Powered by WordPress, state-of-the-art semantic personal publishing platform.">WordPress.org</a></li>			</ul>
			</aside>		</div><!-- #secondary -->
		</div><!-- #main .wrapper -->
	<footer id="colophon" role="contentinfo">
		<div class="site-info">
						<a href="https://wordpress.org/" title="Semantic Personal Publishing Platform">Proudly powered by WordPress</a>
		</div><!-- .site-info -->
	</footer><!-- #colophon -->
</div><!-- #page -->

<script type="text/javascript">
var colomatduration = 'fast';
var colomatslideEffect = 'slideFade';
</script><script type="text/javascript" src="./Build and package your own software for OpenWRT _ ¬´WatchMySys¬ª Blog_files/form.js.t·∫£i xu·ªëng"></script>
<script type="text/javascript" src="./Build and package your own software for OpenWRT _ ¬´WatchMySys¬ª Blog_files/collapse.js.t·∫£i xu·ªëng"></script>
<script type="text/javascript" src="./Build and package your own software for OpenWRT _ ¬´WatchMySys¬ª Blog_files/comment-reply.min.js.t·∫£i xu·ªëng"></script>
<script type="text/javascript" src="./Build and package your own software for OpenWRT _ ¬´WatchMySys¬ª Blog_files/navigation.js.t·∫£i xu·ªëng"></script>
<script type="text/javascript" src="./Build and package your own software for OpenWRT _ ¬´WatchMySys¬ª Blog_files/wp-embed.min.js.t·∫£i xu·ªëng"></script>

<div id="gtx-trans" style="position: absolute; left: 535px; top: 7473px;"><div class="gtx-trans-icon"></div></div></body></html>